stages:
  - deploy

deploy-prod:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh-client bash
  script:
    - echo "🔐 Setup SSH Key..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$EC2_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -t rsa "$EC2_HOST" >> ~/.ssh/known_hosts

    - echo "🚀 Sende Docker Compose-Dateien..."
    - scp docker-compose.prod.yaml $EC2_USER@$EC2_HOST:/home/$EC2_USER/docker-compose.prod.yaml

    - echo "📦 Starte Compose Deploy auf EC2..."
    - ssh $EC2_USER@$EC2_HOST "
        cd /home/$EC2_USER/sem3-template &&
        git pull &&
        docker-compose -f /home/$EC2_USER/docker-compose.prod.yaml up --build -d
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
