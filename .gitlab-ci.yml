stages:
  - deploy

deploy-job:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh bash
  script:
    - chmod 600 "$EC2_KEY"
    - echo "ğŸš€ Deploying Flask Microservice..."
    - |
      ssh -o StrictHostKeyChecking=no -i "$EC2_KEY" $EC2_USER@$EC2_HOST '
        cd ~/sem3-template || git clone https://gitlab.com/Cancani/sem3-template.git && cd sem3-template &&
        git pull &&
        pkill -f run.py || true &&
        python3 -m venv venv &&
        . venv/bin/activate &&
        pip install --upgrade pip &&
        pip install -r requirements.txt &&
        nohup python3 run.py > ~/flask.log 2>&1 &
      '
  only:
    - main
